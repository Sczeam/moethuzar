generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  ADMIN
}

enum CartStatus {
  ACTIVE
  CONVERTED
  ABANDONED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DELIVERING
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  COD
}

enum InventoryChangeType {
  MANUAL_ADJUSTMENT
  ORDER_CONFIRMED
  ORDER_CANCELLED
}

model AdminUser {
  id            String               @id @default(uuid()) @db.Uuid
  authUserId    String               @unique @db.Uuid
  email         String               @unique
  fullName      String?
  role          UserRole             @default(ADMIN)
  isActive      Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  confirmedOrders Order[]            @relation("OrderConfirmedBy")
  statusChanges OrderStatusHistory[] @relation("StatusChangedBy")
}

model Category {
  id        String    @id @default(uuid()) @db.Uuid
  name      String
  slug      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id          String         @id @default(uuid()) @db.Uuid
  name        String
  slug        String         @unique
  description String?
  price       Decimal        @db.Decimal(10, 2)
  currency    String         @default("MMK")
  status      ProductStatus  @default(DRAFT)
  categoryId  String         @db.Uuid
  category    Category       @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  images      ProductImage[]
  variants    ProductVariant[]
  orderItems  OrderItem[]
  logs        InventoryLog[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([categoryId])
  @@index([status])
}

model ProductVariant {
  id             String         @id @default(uuid()) @db.Uuid
  productId      String         @db.Uuid
  sku            String         @unique
  name           String
  color          String?
  size           String?
  material       String?
  price          Decimal?       @db.Decimal(10, 2)
  compareAtPrice Decimal?       @db.Decimal(10, 2)
  inventory      Int            @default(0)
  isActive       Boolean        @default(true)
  sortOrder      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems      CartItem[]
  orderItems     OrderItem[]
  logs           InventoryLog[]

  @@index([productId, isActive])
  @@index([productId, sortOrder])
}

model ProductImage {
  id        String   @id @default(uuid()) @db.Uuid
  productId String   @db.Uuid
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId, sortOrder])
}

model Cart {
  id         String     @id @default(uuid()) @db.Uuid
  guestToken String     @unique
  status     CartStatus @default(ACTIVE)
  currency   String     @default("MMK")
  items      CartItem[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([status])
}

model CartItem {
  id        String         @id @default(uuid()) @db.Uuid
  cartId    String         @db.Uuid
  variantId String         @db.Uuid
  quantity  Int
  price     Decimal        @db.Decimal(10, 2)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@unique([cartId, variantId])
  @@index([variantId])
}

model Order {
  id                 String              @id @default(uuid()) @db.Uuid
  orderCode          String              @unique
  status             OrderStatus         @default(PENDING)
  paymentMethod      PaymentMethod       @default(COD)
  currency           String              @default("MMK")
  subtotalAmount     Decimal             @db.Decimal(12, 2)
  deliveryFeeAmount  Decimal             @default(0) @db.Decimal(12, 2)
  totalAmount        Decimal             @db.Decimal(12, 2)
  customerName       String
  customerPhone      String
  customerEmail      String?
  customerNote       String?
  confirmedByAdminId String?             @db.Uuid
  confirmedAt        DateTime?
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  confirmedBy        AdminUser?          @relation("OrderConfirmedBy", fields: [confirmedByAdminId], references: [id], onDelete: SetNull)
  address            OrderAddress?
  items              OrderItem[]
  history            OrderStatusHistory[]
  logs               InventoryLog[]

  @@index([status, createdAt])
  @@index([customerPhone])
}

model OrderAddress {
  id           String   @id @default(uuid()) @db.Uuid
  orderId      String   @unique @db.Uuid
  country      String   @default("Myanmar")
  stateRegion  String
  townshipCity String
  addressLine1 String
  addressLine2 String?
  postalCode   String?
  createdAt    DateTime @default(now())
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderItem {
  id          String          @id @default(uuid()) @db.Uuid
  orderId     String          @db.Uuid
  productId   String?         @db.Uuid
  variantId   String?         @db.Uuid
  productName String
  productSlug String
  variantName String?
  sku         String?
  unitPrice   Decimal         @db.Decimal(12, 2)
  quantity    Int
  lineTotal   Decimal         @db.Decimal(12, 2)
  createdAt   DateTime        @default(now())
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model OrderStatusHistory {
  id               String      @id @default(uuid()) @db.Uuid
  orderId          String      @db.Uuid
  fromStatus       OrderStatus?
  toStatus         OrderStatus
  note             String?
  changedByAdminId String?     @db.Uuid
  createdAt        DateTime    @default(now())
  order            Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  changedByAdmin   AdminUser?  @relation("StatusChangedBy", fields: [changedByAdminId], references: [id], onDelete: SetNull)

  @@index([orderId, createdAt])
}

model InventoryLog {
  id         String              @id @default(uuid()) @db.Uuid
  productId  String              @db.Uuid
  variantId  String              @db.Uuid
  orderId    String?             @db.Uuid
  changeType InventoryChangeType
  quantity   Int
  note       String?
  createdAt  DateTime            @default(now())
  product    Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant    ProductVariant      @relation(fields: [variantId], references: [id], onDelete: Restrict)
  order      Order?              @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([productId, createdAt])
  @@index([variantId, createdAt])
  @@index([orderId])
}
